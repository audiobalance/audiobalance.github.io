function pad(e,t){for(var o="",i=0;i<t;i++)o+="0";return(o+e).slice(-1*t)}function Preloader(e,t,o,i,n){function a(e,t,o){var n=Math.floor(100/this.queue.length*this.completed.length);h&&(h.style.width=n+"%"),i&&i(e,t,o)}function r(e,t){s&&(s.style.display="none"),console.log("done"),t&&console.log("the following failed",t),o&&o(e,t)}function l(){}if(null!==e){var s=document.createElement("div");s.className="pro360-progress-panel";var c=document.createElement("div");c.className="pro360-progress-panel-text";var d=document.createElement("div");d.className="pro360-progress";var h=document.createElement("div");h.className="pro360-progress-bar",d.appendChild(h),s.appendChild(c),s.appendChild(d),document.querySelector(e).appendChild(s)}return new preLoader(t,{cacheBurst:!1,onProgress:i?i:a,onComplete:r,onError:n?n:l})}var PRO360=function(){function e(e){this.Config=e,this.preloader,this.stage,this.layer,this.image,this.images=[],this.loadedImages={},this.rotatingMode,this.zoomMode,this.globalInterval,this.normalView,this.zoomView,this.originalZoomView,this.init()}function t(e,i){i?t(e):o(e)}function t(e){e.aniTimer&&(clearTimeout(e.aniTimer),e.aniTimer=0),"block"!=e.style.display&&(e.style.opacity=0,e.style.display="block"),e.aniTimer=setTimeout(function(){e.style.opacity=1},0)}function o(e){e.aniTimer&&(clearTimeout(e.aniTimer),e.aniTimer=0),e.style.opacity=0,e.aniTimer=setTimeout(function(){"none"!=e.style.display&&(e.style.display="none")},300)}function i(e){var t=e.Config;if("cross"==t.type){for(var o=t.minX;o<t.maxX;o++)e.images.push(l(e,o,t.startY,t));for(var o=t.minY;o<t.maxY;o++)e.images.push(l(e,t.startX,o,t))}else if("rect"==t.type)for(var o=t.minX;o<t.maxX;o++)for(var i=t.minY;i<t.maxY;i++)e.images.push(l(e,o,i,t));else if("row"==t.type||void 0===t.type)for(var o=t.minX;o<t.maxX;o++)e.images.push(l(e,o,0,t));var n=s(e,t.startX,t.startY,t),a=new Image;a.src=n,g(e),a.onload=function(o){e.loadedImages[n]=a,e.render(t.startX,t.startY)};var r=[],c=[];if("1row"==t.preload)for(var o=0,d=e.images.length;o<d;o++){var h=e.images[o];h.y==t.startY?r.push(h):c.push(h)}else r=e.images;new Preloader(t.containerSelector,_.pluck(r,"src"),function(t,o){if(!o||0==o.length){for(var i=0,n=r.length;i<n;i++){var a=new Image;a.src=r[i].src,e.loadedImages[r[i].src]=a}if(m(e),f(e),c.length){new Preloader(null,_.pluck(c,"src"),function(t,o){for(var i=0,n=c.length;i<n;i++){var a=new Image;a.src=c[i].src,e.loadedImages[c[i].src]=a}})}}})}function n(e){Leap.loop(function(o){if(o.hands&&o.hands[0]){var i=o.hands[0].roll();e.lastHandRoll?t(i):e.lastHandRoll=i}else e.lastHandRoll=void 0});var t=function(t){var o=e.Config,i=Math.PI/3,n=(e.lastHandRoll-t)*o.maxX/i>>0;e.pause(),e.renderRel(n,0),0!=n&&(e.lastHandRoll=t)}}function a(e){var t=document.querySelector(".poiDetails");if(!t){t=document.createElement("div"),t.className="poiDetails";var i=document.createElement("img");i.className="poiDetails-img";var n=document.createElement("div");n.className="poiDetails-txt";var a=document.createElement("div");a.className="poiDetails-back",t.addEventListener("click",function(){e.render(),o(t)}),t.appendChild(i),t.appendChild(n),t.appendChild(a),t.img=i,t.txt=n,document.querySelector(e.Config.containerSelector).appendChild(t)}e.poiDetails=t}function r(e){e.Config.leap&&n(e);var t=function(e){e.rotation&&"wait_while_normal"==e.rotation.status?e.zoom():e.rotation&&"wait_while_zoom"==e.rotation.status&&e.zoom(!1),e.rotation=null,document.removeEventListener("mouseup",e.globalHandler)},o=document.querySelector(e.Config.containerSelector+" canvas"),i=document.querySelector(e.Config.containerSelector);o.ondragstart=function(){return!1},i.addEventListener("wheel",function(t){if(e.Config.scrollZone){var o=e.Config.scrollZone,i=e.normalView,n=(t.layerX-i.x)/i.width,a=(t.layerY-i.y)/i.height;if(n<o.x||n>o.w||a<o.y||a>o.h)return}var r=t.deltaX<0?1:t.deltaX>0?-1:0,l=t.deltaY<0?1:t.deltaY>0?-1:0;Math.abs(t.deltaX)>=Math.abs(t.deltaY)?l=0:r=0,e.pause(),"row"==e.Config.type&&0==r&&0!=l&&(r=l,l=0),e.Config.invertScrollX&&(r=-r),e.renderRel(r,l),t.preventDefault(),t.stopImmediatePropagation()}),e.stage.on("contentMousedown contentTouchstart",function(o){e.globalHandler=_.bind(t,e,e),document.addEventListener("mouseup",e.globalHandler);var i=e.zoomMode,n=e.stage.getPointerPosition();e.rotation={status:i?"wait_while_zoom":"wait_while_normal",startPoint:n,lastPoint:n},e.pause()}),e.stage.on("contentMouseup contentTouchend",function(o){t(e)});var a=function(t){if(e.zoomMode&&!e.rotation){var o=e.stage.getPointerPosition(),i=e.originalZoomView,n=e.normalView;return e.zoomView.x=i.x-Math.min((o.x-e.view.width/2)/(n.width/2),1)*(i.width-n.width)/2,e.zoomView.y=i.y-Math.min((o.y-e.view.height/2)/(n.height/2),1)*(i.height-n.height)/2,void e.renderRel(0,0)}if(e.rotation){var o=e.stage.getPointerPosition(),a=o.x-e.rotation.lastPoint.x,r=-1*(o.y-e.rotation.lastPoint.y);if(!("wait"==e.rotation.status&&Math.abs(a)<4&&Math.abs(r)<4)){e.rotation.status="rotation";var l=e.Config,s=e.image.width()/l.maxX>>1,c=e.image.height()/2/l.maxY>>0,d=!1,h=!1;switch(l.type){case"row":d=!0,h=!1;break;case"col":d=!1,h=!0;break;case"cross":h=e.currentFrameX==l.startX,d=e.currentFrameY==l.startY;break;case"rect":d=!0,h=!0}s=d&&Math.abs(a)>s?-a/s>>0:0,c=h&&Math.abs(r)>c?-r/c>>0:0,0==s&&0==c||(e.renderRel(d?s:0,h?c:0),e.rotation.lastPoint={x:s?o.x:e.rotation.lastPoint.x,y:c?o.y:e.rotation.lastPoint.y})}}};e.stage.on("contentMousemove contentTouchmove",a),e.stage.on("contentDblclick contentDblTap",function(e){})}function l(e,t,o,i){return{x:t,y:o,src:s(e,t,o,i)}}function s(e,t,o,i){var n;if(i.file.fn)n=i.file.fn(t,o);else{i.file.invert&&(t=e.Config.maxX-t);var n=i.file.tpl.replace("{X}",("0000000"+t).slice(-i.file.xwidth));n=n.replace("{Y}",("0000000"+o).slice(-i.file.ywidth))}var a=e.zoomMode?i.zoomfolder:i.folder;return a+n}function c(e){e.Config||(e.Config={});for(var t in p)void 0===e.Config[t]&&(e.Config[t]=p[t]);if("function"==typeof e.Config.file)e.Config.file={fn:e.Config.file};else{var o=e.Config.file;e.Config.file={tpl:o};var i=o?o.match(/{(-)?(X+)}/):null;i&&(e.Config.file.invert=void 0!==i[1],e.Config.file.xwidth=i[2].length,e.Config.file.tpl=e.Config.file.tpl.replace(/{(-)?(X+)}/,"{X}"));var n=o?o.match(/{(Y+)}/):null;n&&(e.Config.file.ywidth=n[1].length,e.Config.file.tpl=e.Config.file.tpl.replace(/{(Y+)}/,"{Y}"))}e.currentFrameX=e.Config.startX,e.currentFrameY=e.Config.startY}function d(e){var t=e.Config,o=!1,i=!1;switch(t.type){case"row":o=!0,i=!1;break;case"col":o=!1,i=!0;break;case"cross":i=e.currentFrameX==t.startX,o=e.currentFrameY==t.startY;break;case"rect":o=!0,i=!0}return{canMoveX:o,canMoveY:i}}function h(e,t,o){var i=document.createElement("div");if(i.className="pro360-"+t,o.appendChild(i),"zoom"==t)return void i.addEventListener("click",function(){e.pause(),e.zoom()});if("play"==t)return void i.addEventListener("click",function(){e.globalInterval?e.pause():e.play()});var n="up"==t||"down"==t?0:"left"==t?-1:1,a="left"==t||"right"==t?0:"down"==t?-1:1,r=function(){e.pause(),clearInterval(e.globalInterval),e.renderRel(n,a),e.globalInterval=setInterval(function(){e.renderRel(n,a)},100)},l=function(){e.pause()};return i.addEventListener("mousedown",r),i.addEventListener("touchstart",r),i.addEventListener("mouseup",l),i.addEventListener("mouseleave",l),i.addEventListener("touchend",l),i}function m(e){if(!e.toolbox){var t=document.querySelector(e.Config.containerSelector+"-toolbox");if(null!=t){t.addEventListener("mouseenter",function(){e.zoomView.x=e.originalZoomView.x,e.zoomView.y=e.originalZoomView.y,e.renderRel(0,0)}),btns=document.createElement("div"),btns.className="pro360-rotatebuttons",t.appendChild(btns),e.toolbox={};for(var o=["up","left","right","down","play"],i=0,n=o.length;i<n;i++)e.toolbox[o[i]]=h(e,o[i],btns)}}}function u(e,t,o,i){for(void 0===t&&(t=e.currentFrameX);t<i.minX;)t=i.allow360X?i.maxX-1+t:i.minX;for(;t>=i.maxX;)t=i.allow360X?t-i.maxX+1:i.maxX-1;for(void 0===o&&(o=e.currentFrameY);o<i.minY;)o=i.allow360Y?i.maxY-1+o:i.minY;for(;o>=i.maxY;)o=i.allow360Y?o-i.maxY+1:i.maxY-1;switch(i.type){case"cross":t!=i.startX&&o!=i.startY&&(Math.abs(t-i.startX)<Math.abs(o-i.startY)?t=i.startX:o=i.startY);break;case"row":o!=i.startY&&(o=i.startY);break;case"col":t!=i.startX&&(t=i.startX);break;case"rect":}e.currentFrameX=t,e.currentFrameY=o}function f(e){e.Config.autoplay&&e.play(!0)}function g(e){var t=document.querySelector(e.Config.containerSelector),o=t.clientWidth,i=t.clientHeight;e.view={width:o,height:i};e.stage=new Konva.Stage({container:t,width:o,height:i,listening:!0}),e.layer=new Konva.Layer;var n=e.Config.borderWidth,l=o-2*n,s=i-2*n,c=e.Config.width/e.Config.height,d=l,h=l/c;h>s&&(h=s,d=c*s),e.normalView={x:(o-d)/2,y:(i-h)/2,width:d,height:h};var m=e.Config.zoomfactor?e.Config.zoomfactor:4;e.originalZoomView={x:(o-d*m)/2,y:(i-h*m)/2,width:d*m,height:h*m},e.zoomView={x:(o-d*m)/2,y:(i-h*m)/2,width:d*m,height:h*m},e.image=new Konva.Image({x:(o-d)/2,y:(i-h)/2,width:d,height:h}),e.layer.add(e.image),e.stage.add(e.layer),r(e),a(e),e.currentFrameY=e.Config.startY||e.Config.minY,e.render(),window.onresize=function(){g(e)}}var p={file:"XXX-YYY.jpg",borderWidth:0,startX:0,startY:0,minDelta:15,allow360:!1,maxY:1,maxX:1,minX:0,minY:0,type:"row",containerSelector:".pro360",preload:"1row"},v=e.prototype;return v.pause=function(){clearInterval(this.globalInterval),this.globalInterval=0;var e=document.querySelector(".pro360-play");e&&(e.className="pro360-play")},v.play=function(){var e=this;void 0===e.forward&&(e.forward=!0);var t=document.querySelector(".pro360-play");t&&(t.className="pro360-play pause"),e.pause(),clearInterval(e.globalInterval),e.globalInterval=setInterval(function(){if(e.Config.autoplay&&e.Config.autoplay.bounce)e.currentFrameX!=e.Config.minX&&e.currentFrameX!=e.Config.maxX-1||(e.forward=!e.forward);else if(e.currentFrameX==e.Config.maxX-1)return void e.render(e.Config.minX,e.currentFrameY);e.renderRel(e.forward?1:-1,0)},e.Config.autoplay.interval)},v.initViewport=function(){g(this)},v.init=function(e){c(this),i(this)},v.render=function(e,t){var o=this.Config;u(this,e,t,o);var i,n=s(this,this.currentFrameX,this.currentFrameY,this.Config);this.zoomMode?(i=new Image,i.src=n):i=this.loadedImages[n];var a=this;void 0===this.frameCounter?this.frameCounter=0:this.frameCounter++;var r=this.frameCounter,l=a.zoomMode&&a.zoomView?a.zoomView:a.normalView,c={x:l.x,y:l.y,width:l.width,height:l.height,timing:Date.now()},d=a.image.getAttrs(),h={x:d.x,y:d.y,width:d.width,height:d.height},m=c.width!=l.width;m?(Math.abs(l.x-h.x)+Math.abs(l.y-h.y))/100:.5;l.x==h.x&&l.y==h.y&&l.width==h.width&&l.height==h.height||TweenLite.to(h,m?.7:.3,{x:l.x,y:l.y,width:l.width,height:l.height,ease:m?Sine.easeInOut:Linear.easeNone,onUpdate:function(){a.image.setAttrs(h),a.layer.batchDraw()}}),this.zoomMode?i.onload=function(e){r<a.frameCounter||(a.image.setImage(i),a.layer.draw())}:(a.image.setImage(i),i&&a.Config.poi&&_.each(a.getPoiCfg(),function(e){a.drawPoi(e,i)}),a.layer.draw(),this.renderToolbox())},v.getPoiCfg=function(){var e=this,i=e.currentFrameX;if(!e.Config.poi)return[];var n=function(e){return e.mask?void(_.find(e.mask,function(e){return e[0]<=i&&i<=e[1]}).length>0):void 0!==e.p[e.conter?37-i:i]},a=[];return _.each(e.Config.poi,function(i,r){if(n(i)){var l=document.querySelector(".poi"+r);if(!l){l=document.createElement("div"),l.className="poi poi"+r;var s=document.createElement("div");s.className="poi-hint",s.textContent=i.label,l.addEventListener("mouseover",function(e){e.target==l&&t(s)}),l.addEventListener("mouseout",function(e){o(s)}),l.addEventListener("click",function(){e.hidePoi(),e.showDetails(i)}),l.appendChild(s),document.querySelector(e.Config.containerSelector).appendChild(l)}i.poi=l,a.push(i)}else i.poi&&"none"!=i.poi.style.display&&(i.poi.style.display="none")}),a},v.hidePoi=function(){this.poiDetails.style.display="none";var e=document.querySelectorAll(".poi");_.each(e,function(e){e.style.display="none"})},v.showDetails=function(e){var o=this,i=o.image;o.poiDetails.img.style.maxWidth=i.width()+"px",o.poiDetails.img.style.maxHeight=i.height()+"px",o.poiDetails.img.src=e.img,o.poiDetails.txt.textContent=e.text,o.poiDetails.style.width=i.width()+"px",o.poiDetails.style.height=i.height()+"px",o.poiDetails.style.left=i.x()+"px",o.poiDetails.style.top=i.y()+"px",t(o.poiDetails)},v.drawPoi=function(e,t){var o=this,i=this.currentFrameX,n=o.normalView.width/t.width,a=o.normalView.height/t.height,r=o.normalView.width/2,l={};_.each(e.p,function(e,t){var o=e.x*n-r,i=e.y*a;l[t]={x:o,y:i}});var s=l[e.conter?37-i:i];e.poi.style.left=s.x+this.view.width/2-e.offset+"px",e.poi.style.top=s.y-e.offset+"px","block"!=e.poi.style.display&&(e.poi.style.display="block")},v.renderRel=function(e,t){this.currentFrameX+=void 0===e?1:e,this.currentFrameY+=void 0===t?1:t,this.render(this.currentFrameX,this.currentFrameY)},v.zoom=function(e){void 0===e?this.zoomMode=!this.zoomMode:this.zoomMode=e,this.zoomMode&&this.hidePoi(),this.rotatingMode=!1,this.zoomView.x=this.originalZoomView.x,this.zoomView.y=this.originalZoomView.y,this.renderRel(0,0)},v.renderToolbox=function(){var e=d(this);this.toolbox&&(e.canMoveX?(this.toolbox.left.style.display="",this.toolbox.right.style.display=""):(this.toolbox.left.style.display="none",this.toolbox.right.style.display="none"),e.canMoveY?(this.toolbox.up.style.display="",this.toolbox.down.style.display=""):(this.toolbox.up.style.display="none",this.toolbox.down.style.display="none"))},e}();